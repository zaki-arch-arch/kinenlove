import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { 
  getFirestore, doc, setDoc, getDoc, collection, onSnapshot, 
  addDoc, query, orderBy, limit 
} from 'firebase/firestore';
import { 
  Heart, Wallet, Activity, Hourglass, Sparkles, Loader2, 
  UserPlus, ScrollText, History, X, Upload, Camera,
  Stethoscope, Timer, RotateCcw
} from 'lucide-react';

// --- Firebase Config ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'tokikin-personal-app';

// --- Constants ---
const CIGARETTE_MINUTES_LOSS = 11; 
const GIFTS = [
  { id: 1, name: 'é«˜ç´šãƒãƒ§ã‚³', cost: 1200, love: 30, icon: 'ğŸ«' },
  { id: 2, name: 'ã‚¢ãƒ­ãƒã‚­ãƒ£ãƒ³ãƒ‰ãƒ«', cost: 3000, love: 80, icon: 'ğŸ•¯ï¸' },
  { id: 3, name: 'ãƒšã‚¢ãƒã‚±ãƒƒãƒˆ', cost: 8000, love: 250, icon: 'ğŸŸï¸' },
  { id: 4, name: 'èª“ã„ã®æŒ‡è¼ª', cost: 50000, love: 1500, icon: 'ğŸ’' },
];

const HEALTH_BENEFITS = [
  { hours: 0, text: "ã¾ãšã¯ä½“å†…ã®ä¸€é…¸åŒ–ç‚­ç´ ã‚’æ’å‡ºã—ã¾ã—ã‚‡ã†ï¼æ·±å‘¼å¸ã—ã¦ã¿ã¦ï¼Ÿ" },
  { hours: 1, text: "è¡€åœ§ã¨è„ˆæ‹ãŒæ­£å¸¸åŒ–ã—å§‹ã‚ã¾ã—ãŸã€‚æ‰‹è¶³ãŒæ¸©ã‹ããªã£ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ" },
  { hours: 8, text: "è¡€ä¸­ã®é…¸ç´ æ¿ƒåº¦ãŒæ­£å¸¸ã«æˆ»ã‚Šã¾ã—ãŸï¼é‹å‹•èƒ½åŠ›ãŒæ”¹å–„ã—å§‹ã‚ã¦ã„ã¾ã™ã€‚" },
  { hours: 24, text: "å¿ƒè‡“ç™ºä½œã®ãƒªã‚¹ã‚¯ãŒä¸‹ãŒã‚Šå§‹ã‚ã¦ã„ã¾ã™ã€‚ç´ æ™´ã‚‰ã—ã„ä¸€æ­©ã§ã™ï¼" },
  { hours: 48, text: "å‘³è¦šã‚„å—…è¦šãŒå¾©æ´»ã—å§‹ã‚ã¾ã—ãŸï¼ã”é£¯ãŒç¾å‘³ã—ãæ„Ÿã˜ã‚‹ã¯ãšã§ã™ã€‚" },
  { hours: 72, text: "ãƒ‹ã‚³ãƒãƒ³ãŒä½“å†…ã‹ã‚‰å®Œå…¨ã«æŠœã‘ã¾ã—ãŸï¼ã“ã“ãŒè¸ã‚“å¼µã‚Šã©ã“ã‚ã§ã™ï¼" },
  { hours: 168, text: "ç¡çœ ãƒªã‚ºãƒ ãŒæ•´ã„ã€ç›®è¦šã‚ãŒã‚¹ãƒƒã‚­ãƒªã—ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚è‚Œãƒ„ãƒ¤ã‚‚ã‚¢ãƒƒãƒ—ï¼" },
  { hours: 720, text: "è¡€æ¶²å¾ªç’°ãŒå¤§å¹…ã«æ”¹å–„ã•ã‚Œã€å†·ãˆæ€§ãŒæ²»ã£ã¦ã„ã‚‹ã‹ã‚‚ã€‚ç¾å®¹åŠ¹æœæŠœç¾¤ï¼" },
  { hours: 2160, text: "è‚ºæ©Ÿèƒ½ãŒ30%ã‚¢ãƒƒãƒ—ï¼éšæ®µã®ä¸Šã‚Šä¸‹ã‚Šã‚‚æ¥½å‹ã§ã™ã­ï¼" },
  { hours: 8760, text: "å¿ƒè‡“ç—…ã®ãƒªã‚¹ã‚¯ãŒå–«ç…™è€…ã®åŠåˆ†ã«ãªã‚Šã¾ã—ãŸï¼ã‚‚ã†ç«‹æ´¾ãªå¥åº·ä½“ã§ã™ï¼" }
];

const DIALOGUES = {
  level1: [ 
    "èª¿å­ã¯ã©ã†ï¼Ÿç„¡ç†ã—ãªã„ã§ã­ã€‚",
    "ä»Šæ—¥ã‚‚ç¦ç…™ã€ç¶šã„ã¦ã‚‹ã­ï¼",
    "ã‚ãªãŸã®å¥åº·ã®ã“ã¨ã€æ°—ã«ãªã£ã¦ã‚‹ã‚“ã ã€‚",
    "æ™‚é–“ãŒçµŒã¤ã»ã©ã€ã‚ãªãŸã¯ç´ æ•µã«ãªã£ã¦ã‚‹ã‚ˆã€‚"
  ],
  level2: [ 
    "æœ€è¿‘ã€é¡”è‰²ãŒè‰¯ããªã£ãŸã¿ãŸã„ï¼ã‚«ãƒƒã‚³ã„ã„ã‚ˆã€‚",
    "ã‚ãªãŸãŒé ‘å¼µã£ã¦ã‚‹å§¿ã€ã™ã”ãåŠ±ã¿ã«ãªã‚‹ã€‚",
    "ã­ãˆã€æµ®ã„ãŸãŠé‡‘ã§ã©ã“ã‹è¡ŒããŸã„ãªâ€¦ãªã‚“ã¦ã€‚",
    "ã‚¿ãƒã‚³ã®åŒ‚ã„ãŒã—ãªã„ã‚ãªãŸã£ã¦ã€æ–°é®®ã ã­ã€‚"
  ],
  level3: [ 
    "ã‚‚ã†ã€ã‚ãªãŸãŒã„ãªã„ã¨å¯‚ã—ã„ã‹ã‚‚â€¦ã€‚",
    "å¤§å¥½ãï¼â€¦ã‚ã€ç¦ç…™ã‚’é ‘å¼µã‚‹ã‚ãªãŸãŒã€ã ã‚ˆï¼Ÿ",
    "ãšã£ã¨ä¸€ç·’ã«å¥åº·ã§ã„ãŸã„ãªã€‚ç´„æŸã ã‚ˆï¼Ÿ",
    "é ‘å¼µã£ãŸã”è¤’ç¾ã€ä½•ãŒã„ã„ï¼Ÿãˆã¸ã¸ã€‚"
  ],
  level4: [ 
    "ã‚ãªãŸã®å…¨ã¦ãŒæ„›ãŠã—ã„ã‚ˆã€‚ã‚‚ã†é›¢ã•ãªã„ã‹ã‚‰ã€‚",
    "ä¸€ç”Ÿéš£ã«ã„ã¦ã­ã€‚ç¶ºéº—ãªè‚ºã®ã‚ãªãŸã¨é•·ç”Ÿãã—ãŸã„ã®ã€‚",
    "æ„›ã—ã¦ã‚‹ã€‚ç¦ç…™ã—ã¦ãã‚Œã¦ã€æœ¬å½“ã«ã‚ã‚ŠãŒã¨ã†ã€‚",
    "ç§ã ã‘ã®ã‚ãªãŸã§ã„ã¦ã€‚â€¦ãµãµã€ç‹¬ã‚Šå ã‚ã€‚"
  ]
};

// --- Main Component ---

export default function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [gameState, setGameState] = useState('loading'); 
  const [isUploading, setIsUploading] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false); 
  const [showHistory, setShowHistory] = useState(false);
  const [showResetConfirm, setShowResetConfirm] = useState(false);
  const [previewImage, setPreviewImage] = useState(null); 

  const [profile, setProfile] = useState({
    dailyTarget: 20,
    pricePerPack: 600,
    startQuitDate: null, 
    lastCheckDate: null, 
    accumulatedMoney: 0, 
    accumulatedLife: 0,  
    affection: 0,
    currentHeroineId: null,
  });

  const [heroines, setHeroines] = useState([]);
  const [historyLogs, setHistoryLogs] = useState([]);
  const [currentHeroine, setCurrentHeroine] = useState(null);
  const [dialogue, setDialogue] = useState('å¾…ã£ã¦ãŸã‚ˆï¼');
  const [eventData, setEventData] = useState(null);

  const [timerDisplay, setTimerDisplay] = useState({ d:0, h:0, m:0, s:0 });
  const [realtimeStats, setRealtimeStats] = useState({
    money: 0, life: 0, health: 0, totalHours: 0
  });

  // --- Helpers ---
  const getRandomDialogue = (aff) => {
    const lv = Math.floor(aff / 100) + 1;
    let list = DIALOGUES.level1;
    if (lv >= 16) list = DIALOGUES.level4;
    else if (lv >= 8) list = DIALOGUES.level3;
    else if (lv >= 4) list = DIALOGUES.level2;
    return list[Math.floor(Math.random() * list.length)];
  };

  const getHealthTrivia = (hours) => {
    const achieved = HEALTH_BENEFITS.filter(h => h.hours <= hours);
    if (achieved.length === 0) return HEALTH_BENEFITS[0].text;
    return achieved[achieved.length - 1].text;
  };

  // --- Initialization ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth failed", error);
        alert("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
      }
    };
    initAuth();

    return onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (!u) setLoading(false);
    });
  }, []);

  // --- Timer Logic ---
  useEffect(() => {
    if (!profile.startQuitDate) return;

    const interval = setInterval(() => {
      const now = new Date();
      const start = new Date(profile.startQuitDate);
      const diffMs = now - start;
      
      if (diffMs < 0) return; 

      const seconds = Math.floor((diffMs / 1000) % 60);
      const minutes = Math.floor((diffMs / (1000 * 60)) % 60);
      const hours = Math.floor((diffMs / (1000 * 60 * 60)) % 24);
      const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      setTimerDisplay({ d: days, h: hours, m: minutes, s: seconds });

      const totalMinutes = diffMs / (1000 * 60);
      const totalHours = totalMinutes / 60;
      
      const cigsPerMin = profile.dailyTarget / (24 * 60);
      const avoided = totalMinutes * cigsPerMin;
      
      const unitPrice = profile.pricePerPack / 20;
      const money = Math.floor(avoided * unitPrice);
      const life = Math.floor(avoided * CIGARETTE_MINUTES_LOSS);
      const health = Math.min(100, (totalHours / 720) * 100);

      setRealtimeStats({ 
        money: (profile.accumulatedMoney || 0) + money, 
        life: (profile.accumulatedLife || 0) + life, 
        health: health,
        totalHours: totalHours
      });

    }, 1000);

    return () => clearInterval(interval);
  }, [profile]);

  // --- Realtime Sync ---
  useEffect(() => {
    if (!user) return;

    const statsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'stats', 'current');
    const unsubStats = onSnapshot(statsRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        setProfile(data);
        
        if (gameState !== 'event') {
          setDialogue(getRandomDialogue(data.affection || 0));
        }

        if (data.currentHeroineId) {
          fetchHeroine(data.currentHeroineId);
        } else {
          setGameState('setup');
        }
      } else {
        setGameState('setup');
      }
      setLoading(false);
    });

    const heroinesCol = collection(db, 'artifacts', appId, 'users', user.uid, 'heroines');
    const unsubHeroines = onSnapshot(heroinesCol, (snap) => {
      const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setHeroines(list);
    });

    const logsCol = collection(db, 'artifacts', appId, 'users', user.uid, 'logs');
    const logsQuery = query(logsCol, orderBy('createdAt', 'desc'), limit(20));
    const unsubLogs = onSnapshot(logsQuery, (snap) => {
      const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setHistoryLogs(list);
    });

    return () => {
      unsubStats();
      unsubHeroines();
      unsubLogs();
    };
  }, [user]);

  const fetchHeroine = async (id) => {
    try {
      const hRef = doc(db, 'artifacts', appId, 'users', user.uid, 'heroines', id);
      const hSnap = await getDoc(hRef);
      if (hSnap.exists()) {
        setCurrentHeroine({ id, ...hSnap.data() });
        if (gameState !== 'event') setGameState('main');
      } else {
        setGameState('char_reg');
      }
    } catch (e) {
      console.error("Heroine fetch error", e);
      setGameState('char_reg');
    }
  };

  // --- Actions ---

  const saveLog = async (text, type = 'info') => {
    if (!user) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'logs'), {
        text, type, createdAt: new Date().toISOString()
      });
    } catch (e) {
      console.error("Log save error", e);
    }
  };

  const resizeImage = (file) => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          const maxDim = 600;
          if (width > height) { if (width > maxDim) { height *= maxDim / width; width = maxDim; } } else { if (height > maxDim) { width *= maxDim / height; height = maxDim; } }
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL('image/jpeg', 0.8));
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  };

  const handleFileSelect = async (e) => {
    const file = e.target.files[0];
    if (file) {
      const resizedDataUrl = await resizeImage(file);
      setPreviewImage(resizedDataUrl);
    }
  };

  const handleManualUpload = async (e) => {
    e.preventDefault();
    if (!previewImage) { alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    setIsUploading(true);
    const f = new FormData(e.target);
    const name = f.get('name');
    const type = f.get('type');
    const imageUrl = previewImage; 
    const newHeroine = { name, type, description: 'ã‚«ã‚¹ã‚¿ãƒ ç”»åƒ', imageUrl, createdAt: new Date().toISOString() };
    try {
      if (imageUrl.length * 0.75 > 950000) throw new Error("ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™");
      
      const heroinesCol = collection(db, 'artifacts', appId, 'users', user.uid, 'heroines');
      const res = await addDoc(heroinesCol, newHeroine);
      
      await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'stats', 'current'), { ...profile, currentHeroineId: res.id }, { merge: true });
      await saveLog(`${name} ã‚’ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«è¨­å®šã—ã¾ã—ãŸ`, 'system');
      setPreviewImage(null);
      e.target.reset();
    } catch (err) {
      console.error(err);
      alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + err.message);
    } finally {
      setIsUploading(false);
    }
  };

  const handleRelapseConfirm = () => {
    setShowResetConfirm(true);
  };

  const executeRelapse = async () => {
    if (!user) return;
    setIsProcessing(true);
    setShowResetConfirm(false); 
    try {
      const now = new Date().toISOString();
      const newStats = {
        ...profile,
        startQuitDate: now,
        lastCheckDate: now,
        accumulatedMoney: realtimeStats.money,
        accumulatedLife: realtimeStats.life,
        affection: Math.max(0, (profile.affection || 0) - 50)
      };
      await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'stats', 'current'), newStats);
      await saveLog("ç¦ç…™ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ", 'fail');
      setEventData({
        type: 'fail',
        msg: "ã€Œå¤§ä¸ˆå¤«ã€‚ã¾ãŸä¸€ç·’ã«é ‘å¼µã‚ã†ï¼Ÿã€",
        systemMsg: "ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚\nã“ã‚Œã¾ã§ã®åŠªåŠ›ï¼ˆè²¯é‡‘ãƒ»å¯¿å‘½ï¼‰ã¯ç´¯ç©ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ®‹ã‚Šã¾ã™ã€‚",
        loveChange: -50,
        newLove: newStats.affection
      });
      setGameState('event');
    } catch (e) {
      console.error(e);
      alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    } finally {
      setIsProcessing(false);
    }
  };

  const handleGift = async (gift) => {
    if (realtimeStats.money < gift.cost) return;
    setIsProcessing(true);
    try {
      const newStats = {
        ...profile,
        accumulatedMoney: profile.accumulatedMoney - gift.cost, 
        affection: (profile.affection || 0) + gift.love
      };
      await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'stats', 'current'), newStats);
      await saveLog(`${gift.name} ã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ`, 'gift');
      setEventData({
        type: 'gift',
        msg: `ã€Œ${gift.name}ï¼ã‚ã‚ŠãŒã¨ã†ï¼${getRandomDialogue(newStats.affection)}ã€`,
        systemMsg: `å¥½æ„Ÿåº¦ UPï¼`,
        loveChange: gift.love,
        newLove: newStats.affection
      });
      setGameState('event');
    } catch (e) {
      console.error(e);
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    } finally {
      setIsProcessing(false);
    }
  };

  const formatLifespan = (minutes) => {
    const d = Math.floor(minutes / (24 * 60));
    const h = Math.floor((minutes % (24 * 60)) / 60);
    return `${d}æ—¥${h}æ™‚é–“`;
  };

  // --- UI Components ---

  const ResetConfirmModal = () => (
    <div className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4">
      <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl animate-in zoom-in">
        <h3 className="text-lg font-bold mb-4 text-red-500 flex items-center gap-2">
          <RotateCcw size={20} /> ãƒªã‚»ãƒƒãƒˆç¢ºèª
        </h3>
        <p className="text-sm text-gray-600 mb-6 leading-relaxed">
          æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ<br/>
          ç¾åœ¨ã®ã‚¿ã‚¤ãƒãƒ¼ã¯0ã«æˆ»ã‚Šã¾ã™ãŒã€ã“ã‚Œã¾ã§ã®è¨˜éŒ²ï¼ˆè²¯é‡‘ã‚„å¯¿å‘½ï¼‰ã¯ç´¯ç©ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ®‹ã‚Šã¾ã™ã€‚
        </p>
        <div className="flex gap-3">
          <button 
            onClick={() => setShowResetConfirm(false)} 
            className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-xl hover:bg-gray-200 transition"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button 
            onClick={executeRelapse} 
            className="flex-1 bg-red-500 text-white rounded-xl py-3 font-bold shadow-lg hover:bg-red-600 transition"
          >
            ãƒªã‚»ãƒƒãƒˆã™ã‚‹
          </button>
        </div>
      </div>
    </div>
  );

  const HistoryModal = () => (
    <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
      <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl animate-in zoom-in h-[70vh] flex flex-col">
        <div className="flex justify-between items-center mb-4 border-b pb-2">
           <h3 className="text-lg font-bold flex items-center gap-2">
             <ScrollText className="text-indigo-500" /> æ´»å‹•è¨˜éŒ²
           </h3>
           <button onClick={() => setShowHistory(false)}><X className="text-gray-400" /></button>
        </div>
        <div className="flex-1 overflow-y-auto space-y-3">
          {historyLogs.length === 0 ? (
            <p className="text-center text-gray-400 text-sm py-10">è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
          ) : (
            historyLogs.map(log => (
              <div key={log.id} className="text-sm border-l-2 border-gray-200 pl-3 py-1">
                <p className="text-xs text-gray-400 mb-1">{new Date(log.createdAt).toLocaleString()}</p>
                <p className={`font-medium ${
                  log.type === 'success' ? 'text-green-600' : 
                  log.type === 'fail' ? 'text-red-500' :
                  log.type === 'gift' ? 'text-rose-500' : 'text-gray-700'
                }`}>
                  {log.text}
                </p>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-rose-500" /></div>;

  // 1. Setup Screen
  if (gameState === 'setup') {
    return (
      <div className="min-h-screen bg-rose-100 flex items-center justify-center p-6">
        <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md border-b-8 border-rose-200">
          <h1 className="text-2xl font-black text-rose-500 mb-6 flex items-center justify-center gap-2">
            <Heart className="fill-rose-500" /> ç¦ç…™ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«
          </h1>
          <p className="text-center text-gray-500 text-sm mb-6">è¨­å®šã‚’å…¥åŠ›ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼</p>
          <form onSubmit={(e) => {
            e.preventDefault();
            const f = new FormData(e.target);
            const now = new Date().toISOString();
            setProfile(p => ({ 
              ...p, 
              dailyTarget: parseInt(f.get('c')) || 20, 
              pricePerPack: parseInt(f.get('p')) || 600,
              startQuitDate: now,
              lastCheckDate: now
            }));
            setGameState('char_reg');
          }} className="space-y-4">
            <div className="space-y-1">
              <label className="text-xs font-bold text-gray-400 ml-2">1æ—¥ã®å–«ç…™æœ¬æ•°</label>
              <input type="number" name="c" placeholder="20" defaultValue={20} className="w-full p-4 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-rose-200" required />
            </div>
            <div className="space-y-1">
              <label className="text-xs font-bold text-gray-400 ml-2">1ç®±ã®å€¤æ®µ</label>
              <input type="number" name="p" placeholder="600" defaultValue={600} className="w-full p-4 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-rose-200" required />
            </div>
            <button className="w-full bg-rose-500 text-white font-bold py-4 rounded-xl shadow-lg hover:scale-105 transition">æ¬¡ã¸é€²ã‚€</button>
          </form>
        </div>
      </div>
    );
  }

  // 2. Character Register
  if (gameState === 'char_reg') {
    return (
      <div className="min-h-screen bg-slate-50 p-6 pb-24 overflow-y-auto">
        <div className="flex justify-between items-center mb-6">
           <h2 className="text-xl font-black text-slate-800 flex items-center gap-2"><UserPlus /> ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ç™»éŒ²</h2>
           {/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®è¿½åŠ  */}
           {currentHeroine && (
             <button onClick={() => setGameState('main')} className="p-2 bg-white rounded-full shadow text-gray-500 hover:bg-gray-100 transition">
               <X size={20} />
             </button>
           )}
        </div>

        <div className="bg-white p-6 rounded-3xl shadow-sm mb-8 border border-indigo-100">
           <p className="text-sm text-gray-500 mb-4 font-bold text-center">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
           <form onSubmit={handleManualUpload} className="space-y-4">
             <div className="border-2 border-dashed border-gray-300 rounded-xl min-h-[200px] flex items-center justify-center hover:bg-gray-50 transition cursor-pointer relative overflow-hidden group bg-gray-50">
               <input type="file" name="file" accept="image/*" onChange={handleFileSelect} className="absolute inset-0 opacity-0 cursor-pointer z-20" required={!previewImage} />
               {previewImage ? (
                 <>
                   <img src={previewImage} className="w-full h-full object-contain absolute inset-0 z-10 p-2" alt="Preview" />
                   <div className="absolute inset-0 bg-black/40 z-10 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                     <p className="text-white font-bold flex items-center gap-2"><Camera size={16}/> å¤‰æ›´ã™ã‚‹</p>
                   </div>
                 </>
               ) : (
                 <div className="text-center p-6">
                   <Upload className="mx-auto text-gray-400 mb-2" size={32} />
                   <span className="text-sm text-gray-500 font-bold block">ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’é¸æŠ</span>
                   <p className="text-xs text-gray-400 mt-2">æ¨ã—ã®å†™çœŸãªã©ã‚’ç™»éŒ²ã—ã¦ã­ï¼</p>
                 </div>
               )}
             </div>
             <input name="name" placeholder="ã‚­ãƒ£ãƒ©ã®åå‰" className="w-full p-4 bg-slate-100 rounded-xl border-none outline-none focus:ring-2 focus:ring-indigo-200" required />
             <select name="type" className="w-full p-4 bg-slate-100 rounded-xl border-none outline-none focus:ring-2 focus:ring-indigo-200">
               <option value="å¯æ„›ã„">ã‚¿ã‚¤ãƒ—ï¼šå¯æ„›ã„</option>
               <option value="ã‚¯ãƒ¼ãƒ«">ã‚¿ã‚¤ãƒ—ï¼šã‚¯ãƒ¼ãƒ«</option>
               <option value="ç¶ºéº—">ã‚¿ã‚¤ãƒ—ï¼šç¶ºéº—</option>
               <option value="ãã®ä»–">ã‚¿ã‚¤ãƒ—ï¼šãã®ä»–</option>
             </select>
             <button disabled={!previewImage || isUploading} className="w-full bg-slate-800 text-white font-bold py-4 rounded-xl shadow hover:bg-slate-900 disabled:opacity-50 flex items-center justify-center gap-2">
               {isUploading ? <><Loader2 className="animate-spin"/> ç™»éŒ²ä¸­...</> : "ã“ã®ã‚­ãƒ£ãƒ©ã§å§‹ã‚ã‚‹"}
             </button>
           </form>
        </div>

        {heroines.length > 0 && (
          <>
            <h3 className="font-bold text-gray-400 text-sm mb-4">ä¿å­˜æ¸ˆã¿ã‚­ãƒ£ãƒ©ãƒªã‚¹ãƒˆ</h3>
            <div className="grid grid-cols-2 gap-4">
              {heroines.map(h => (
                <div key={h.id} onClick={async () => {
                  await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'stats', 'current'), { ...profile, currentHeroineId: h.id }, { merge: true });
                }} className="bg-white p-3 rounded-2xl shadow-sm border-2 border-transparent hover:border-rose-400 cursor-pointer transition relative">
                  <div className="aspect-square rounded-xl bg-gray-100 mb-3 overflow-hidden">
                    <img src={h.imageUrl} className="w-full h-full object-cover" alt={h.name} />
                  </div>
                  <p className="font-bold text-center">{h.name}</p>
                  <p className="text-xs text-center text-gray-400 truncate">{h.type}</p>
                </div>
              ))}
            </div>
          </>
        )}
      </div>
    );
  }

  // 3. Main Game (main or event)
  if ((gameState === 'main' || gameState === 'event') && currentHeroine) {
    const affection = profile.affection || 0; 
    const loveLevel = Math.floor(affection / 100) + 1;
    const nextLoveExp = (affection % 100);

    return (
      <div className="min-h-screen bg-slate-50 flex flex-col max-w-md mx-auto relative overflow-hidden">
        {/* Header Icons & Love Gauge */}
        <div className="absolute top-0 w-full p-4 z-30 space-y-2">
           <div className="flex justify-between items-center">
             <div className="flex gap-2">
               <button onClick={() => setShowHistory(true)} className="bg-white/80 backdrop-blur px-3 py-1 rounded-full text-xs font-bold shadow text-indigo-500 flex items-center gap-1">
                 <History size={12}/> å±¥æ­´
               </button>
             </div>
             <button onClick={() => setGameState('char_reg')} className="bg-white/80 backdrop-blur p-2 rounded-full shadow text-gray-500">
               <UserPlus size={16} />
             </button>
           </div>
           
           <div className="bg-white/90 backdrop-blur rounded-full p-1 shadow-sm flex items-center gap-2 pr-3">
              <div className="bg-rose-500 text-white text-[10px] font-bold px-2 py-1 rounded-full">
                Love Lv.{loveLevel}
              </div>
              <div className="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                <div className="h-full bg-rose-400 transition-all duration-700" style={{ width: `${nextLoveExp}%` }}></div>
              </div>
              <Heart size={12} className="text-rose-400 fill-rose-400"/>
           </div>
        </div>

        {/* Character View */}
        <div className="flex-1 flex flex-col items-center justify-center relative bg-gradient-to-b from-rose-100 to-slate-50 pt-28 pb-10">
          <div className="w-72 h-72 rounded-full border-8 border-white shadow-2xl overflow-hidden relative z-10 bg-white">
            <img src={currentHeroine.imageUrl} className="w-full h-full object-cover" alt="" />
          </div>
          
          <div className="mt-6 bg-white/90 backdrop-blur border border-rose-100 px-6 py-4 rounded-3xl shadow-lg max-w-[85%] z-20 text-center animate-in slide-in-from-bottom-4">
             <p className="font-bold text-gray-700 text-sm leading-relaxed">
               ã€Œ{dialogue}ã€
             </p>
          </div>
        </div>

        {/* Timer & Stats Area */}
        <div className="bg-white rounded-t-[2.5rem] shadow-[0_-10px_40px_rgba(0,0,0,0.05)] p-6 z-20 space-y-6">
           
           {/* Timer Display */}
           <div className="text-center space-y-1">
             <div className="flex items-center justify-center gap-1 text-xs font-bold text-gray-400 uppercase tracking-widest">
               <Timer size={12} /> ç¦ç…™ç¶™ç¶šæ™‚é–“
             </div>
             <div className="font-black text-3xl text-slate-800 tabular-nums">
               {timerDisplay.d}æ—¥ <span className="text-2xl">{String(timerDisplay.h).padStart(2,'0')}:{String(timerDisplay.m).padStart(2,'0')}:{String(timerDisplay.s).padStart(2,'0')}</span>
             </div>
           </div>

           {/* Gauges */}
           <div className="grid grid-cols-2 gap-4">
              <div className="bg-rose-50 p-3 rounded-2xl">
                 <div className="flex items-center justify-between gap-1 text-xs font-bold text-rose-400 mb-1">
                   <span className="flex items-center gap-1"><Stethoscope size={12}/> å¥åº·åº¦</span>
                   <span>{Math.floor(realtimeStats.health)}%</span>
                 </div>
                 <div className="h-2 bg-rose-200 rounded-full overflow-hidden">
                    <div className="h-full bg-emerald-500 transition-all duration-1000" style={{width: `${realtimeStats.health}%`}}></div>
                 </div>
                 <p className="text-[10px] text-rose-300 mt-1 leading-tight">{getHealthTrivia(realtimeStats.totalHours)}</p>
              </div>
              <div className="space-y-2">
                <div className="bg-blue-50 p-3 rounded-2xl flex flex-col justify-center">
                   <div className="flex items-center gap-1 text-xs font-bold text-blue-400 mb-1"><Hourglass size={12}/> å¯¿å‘½</div>
                   <div className="text-sm font-black text-blue-600">{formatLifespan(realtimeStats.life)}</div>
                </div>
                <div className="bg-amber-50 p-3 rounded-2xl flex flex-col justify-center">
                   <div className="flex items-center gap-1 text-xs font-bold text-amber-400 mb-1"><Wallet size={12}/> ç¯€ç´„</div>
                   <div className="text-sm font-black text-amber-600">Â¥{realtimeStats.money.toLocaleString()}</div>
                </div>
              </div>
           </div>

           {/* Actions */}
           <div className="space-y-3">
              <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                 {GIFTS.map(g => (
                   <button key={g.id} onClick={() => handleGift(g)} disabled={realtimeStats.money < g.cost || isProcessing}
                     className="shrink-0 bg-gray-50 border hover:border-rose-300 p-2 rounded-xl flex flex-col items-center min-w-[70px] disabled:opacity-50 transition">
                     <span className="text-lg">{g.icon}</span>
                     <span className="text-[10px] font-bold">Â¥{g.cost}</span>
                   </button>
                 ))}
              </div>
              
              <button 
                onClick={handleRelapseConfirm}
                disabled={isProcessing}
                className="w-full py-3 text-xs font-bold text-gray-400 hover:text-red-500 flex items-center justify-center gap-1 transition"
              >
                <RotateCcw size={12} /> å¸ã£ã¦ã—ã¾ã£ãŸâ€¦ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰
              </button>
           </div>
        </div>

        {/* Modals */}
        {gameState === 'event' && eventData && (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-6">
             <div className="bg-white w-full max-w-sm rounded-3xl p-8 text-center space-y-4 animate-in zoom-in">
                <Sparkles className="mx-auto text-yellow-400" size={48} />
                <h3 className="text-xl font-black text-gray-800">ã€Œ{eventData.msg}ã€</h3>
                
                {eventData.loveChange !== 0 && (
                   <div className="space-y-1 bg-rose-50 p-3 rounded-2xl">
                      <div className="flex justify-between text-xs font-bold text-rose-500 px-1">
                        <span>Love Lv.{Math.floor(eventData.newLove / 100) + 1}</span>
                        <span>{eventData.loveChange > 0 ? '+' : ''}{eventData.loveChange}</span>
                      </div>
                      <div className="h-3 bg-rose-200 rounded-full overflow-hidden">
                        <div className="h-full bg-rose-500 transition-all duration-1000" style={{ width: `${eventData.newLove % 100}%` }}></div>
                      </div>
                   </div>
                )}
                
                <div className="text-sm text-gray-600 bg-gray-50 p-4 rounded-2xl whitespace-pre-wrap text-left leading-relaxed border border-gray-100">
                  {eventData.systemMsg}
                </div>
                
                <button onClick={() => setGameState('main')} className="w-full bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">OK</button>
             </div>
          </div>
        )}
        {showHistory && <HistoryModal />}
        {showResetConfirm && <ResetConfirmModal />}
      </div>
    );
  }

  return null;
}
