<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ãƒˆã‚­ãƒ¡ã‚­ç¦ç…™ãƒ¡ãƒ¢ãƒªã‚¢ãƒ« å®Œå‹•ç‰ˆ</title>
<style>
    /* å¤–éƒ¨CSSã‚’ä½¿ã‚ãšã€ã“ã“ã«å…¨ã¦è¨˜è¿°ã—ã¾ã™ */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif; background-color: #fff1f2; color: #334155; overscroll-behavior-y: none; }
    
    /* å…±é€šã‚¯ãƒ©ã‚¹ */
    .container { width: 100%; min-height: 100vh; padding-bottom: 120px; display: flex; flex-direction: column; align-items: center; }
    .header { width: 100%; padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: rgba(255, 241, 242, 0.9); z-index: 100; backdrop-filter: blur(5px); }
    
    /* ãƒœã‚¿ãƒ³ */
    .btn { border: none; padding: 12px 24px; border-radius: 99px; font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s; text-align: center; }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background-color: #f43f5e; color: white; width: 100%; }
    .btn-danger { background-color: #1e293b; color: white; width: 100%; }
    .btn-small { padding: 6px 12px; font-size: 12px; }
    .btn-reset { background: white; color: #f43f5e; border: 1px solid #fecdd3; }
    
    /* ã‚«ãƒ¼ãƒ‰ */
    .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; width: 100%; }
    .row { display: flex; gap: 15px; width: 100%; }
    .col { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }

    /* ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ç”»åƒ */
    .heroine-area { margin-top: 20px; display: flex; flex-direction: column; align-items: center; position: relative; z-index: 10; }
    .heroine-img { width: 280px; height: 280px; border-radius: 50%; border: 6px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); object-fit: cover; background: #e2e8f0; }
    .balloon { background: rgba(255,255,255,0.95); padding: 15px; border-radius: 15px; border: 1px solid #ffe4e6; margin-top: -20px; position: relative; z-index: 20; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; font-weight: bold; max-width: 90%; min-width: 200px; }
    
    /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
    .input-group { margin-bottom: 15px; text-align: left; }
    .label { font-size: 12px; color: #64748b; font-weight: bold; display: block; margin-bottom: 5px; }
    .input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; background: #f8fafc; font-size: 16px; }

    /* ã‚®ãƒ•ãƒˆãƒªã‚¹ãƒˆ */
    .gift-list { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 10px; width: 100%; -webkit-overflow-scrolling: touch; }
    .gift-item { flex: 0 0 120px; background: white; border-radius: 15px; padding: 15px; display: flex; flex-direction: column; align-items: center; border: 1px solid #f1f5f9; position: relative; }
    .gift-badge { position: absolute; top: 5px; right: 5px; background: #facc15; color: #713f12; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    .footer { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 15px 20px; border-top: 1px solid #f1f5f9; z-index: 90; }
    .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-top: 5px; }
    .progress-val { height: 100%; background: linear-gradient(90deg, #fca5a5, #f43f5e); transition: width 0.5s; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal-content { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 320px; text-align: center; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
    .animate-breathe { animation: breathe 6s ease-in-out infinite; }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    .text-center { text-align: center; }
    .text-rose { color: #f43f5e; }
    .text-big { font-size: 24px; font-weight: 900; }
    .text-small { font-size: 12px; color: #64748b; }
    .mt-4 { margin-top: 20px; }
    .mb-2 { margin-bottom: 10px; }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:#fff1f2; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index: 9999; }
</style>
</head>
<body>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ (JSãŒå‹•ã‹ãªãã¦ã‚‚è¡¨ç¤ºã•ã‚Œã‚‹) -->
    <div id="loading">
        <div style="font-size:40px; margin-bottom:10px;">ğŸ’—</div>
        <div style="font-weight:bold; color:#f43f5e;">Loading...</div>
        <!-- æ•‘æ¸ˆãƒœã‚¿ãƒ³ -->
        <button onclick="if(confirm('åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')){localStorage.clear();location.reload();}" style="margin-top:30px; font-size:12px; color:#999; background:none; border:1px solid #ccc; padding:5px 10px; border-radius:5px;">
            å‹•ã‹ãªã„å ´åˆã¯ã“ã“ã‚’æŠ¼ã—ã¦ãƒªã‚»ãƒƒãƒˆ
        </button>
    </div>

    <!-- ã‚¢ãƒ—ãƒªæç”»ã‚¨ãƒªã‚¢ -->
    <div id="app"></div>

    <script>
        // --- è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ ---
        var APP_KEY = 'tokikin_pure_v1';
        
        var GIFTS = [
            { id: 1, name: 'ã‚³ãƒ³ãƒ“ãƒ‹ã‚¹ã‚¤ãƒ¼ãƒ„', cost: 500, icon: 'ğŸ°', love: 15 },
            { id: 2, name: 'æ–°ä½œã‚³ã‚¹ãƒ¡', cost: 3000, icon: 'ğŸ’„', love: 80 },
            { id: 3, name: 'æ¸©æ³‰æ—…è¡Œ', cost: 15000, icon: 'â™¨ï¸', love: 450 },
            { id: 4, name: 'æ„›ã®èª“ã„', cost: 100000, icon: 'ğŸ’', love: 2500 }
        ];

        var SCENARIO = {
            morning: ["ãŠã¯ã‚ˆã†ï¼ä»Šæ—¥ã‚‚è‚ºã‚’ã‚­ãƒ¬ã‚¤ã«ã—ã‚ˆã†ï¼", "æœã®æ·±å‘¼å¸ã€æ°—æŒã¡ã„ã„ï¼Ÿ", "ä»Šæ—¥ã‚‚è¨˜éŒ²æ›´æ–°é ‘å¼µã‚ã†ï¼"],
            day: ["ãŠç–²ã‚Œæ§˜ï¼æ°´é£²ã‚“ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã‚ˆï¼Ÿ", "åˆå¾Œã®çœ æ°—ã¯ã‚¹ãƒˆãƒ¬ãƒƒãƒã§é£›ã°ãã†ï¼", "é ‘å¼µã£ã¦ã‚‹ã­ï¼ã™ã”ã„ã‚ˆã€‚"],
            night: ["ä»Šæ—¥ã‚‚ãŠç–²ã‚Œæ§˜ã€‚å¸ã‚ãšã«å‰ã„ï¼", "æ˜æ—¥ã®ç›®è¦šã‚ãŒæ¥½ã—ã¿ã ã­ã€‚", "ã‚†ã£ãã‚ŠãŠé¢¨å‘‚ã«å…¥ã£ã¦ä¼‘ã‚“ã§ã­ã€‚"],
            lateNight: ["ã¾ã èµ·ãã¦ã‚‹ã®ï¼Ÿæ—©ãå¯ãªã„ã¨è‚Œã«æ‚ªã„ã‚ˆã€‚", "ã“ã‚“ãªæ™‚é–“ã¾ã§èµ·ãã¦ã¦å¤§ä¸ˆå¤«ï¼Ÿ"]
        };

        var OMIKUJI = [
            { type: 'å¤§å‰', love: 50, msg: 'ä»Šæ—¥ã¯æœ€é«˜ã®ç¦ç…™æ—¥å’Œï¼' },
            { type: 'ä¸­å‰', love: 30, msg: 'æ·±å‘¼å¸ã§é‹æ°—ã‚¢ãƒƒãƒ—ï¼' },
            { type: 'å°å‰', love: 20, msg: 'åœ°é“ãªåŠªåŠ›ãŒå®Ÿã‚’çµã¶æ—¥ã€‚' }
        ];

        var HEALTH_BENEFITS = [
            { hours: 0, title: "ã‚¹ã‚¿ãƒ¼ãƒˆï¼", text: "ã¾ãšã¯æ·±å‘¼å¸ï¼ä½“å†…ã®ä¸€é…¸åŒ–ç‚­ç´ æ’å‡ºãŒå§‹ã¾ã‚Šã¾ã™ã€‚" },
            { hours: 24, title: "å¿ƒè‡“ç™ºä½œãƒªã‚¹ã‚¯ä½ä¸‹", text: "24æ™‚é–“é”æˆï¼å¿ƒè‡“ã¸ã®è² æ‹…ãŒæ¸›ã‚Šå§‹ã‚ã¦ã„ã¾ã™ã€‚" },
            { hours: 72, title: "ãƒ‹ã‚³ãƒãƒ³æ¶ˆå¤±", text: "ä½“å†…ã‹ã‚‰ãƒ‹ã‚³ãƒãƒ³ãŒå®Œå…¨ã«æŠœã‘ã¾ã—ãŸï¼è¸ã‚“å¼µã‚Šã©ã“ã‚ï¼" },
            { hours: 168, title: "ç¡çœ ãƒªã‚ºãƒ ã®æ”¹å–„", text: "1é€±é–“é”æˆï¼ç¡çœ ã®è³ªãŒè‰¯ããªã‚Šã€ç›®è¦šã‚ãŒã‚¹ãƒƒã‚­ãƒªã—ã¾ã™ã€‚" },
            { hours: 720, title: "è¡€è¡Œæ”¹å–„ãƒ»ç¾è‚ŒåŠ¹æœ", text: "1ãƒ¶æœˆé”æˆï¼è¡€æ¶²å¾ªç’°ãŒè‰¯ããªã‚Šã€è‚Œã®ãƒˆãƒ¼ãƒ³ãŒæ˜ã‚‹ããªã‚Šã¾ã™ã€‚" },
            { hours: 8760, title: "å¿ƒè‡“ç—…ãƒªã‚¹ã‚¯åŠæ¸›", text: "1å¹´é”æˆï¼å¿ƒè‡“ç–¾æ‚£ã®ãƒªã‚¹ã‚¯ãŒå–«ç…™è€…ã®åŠåˆ†ã«ãªã‚Šã¾ã—ãŸï¼" }
        ];

        // --- ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç† (Global) ---
        var state = {
            view: 'loading', // loading, setup, char_reg, main
            profile: null,
            heroines: [],
            modal: null, // null | 'sos' | 'reset' | 'popup'
            popupData: null,
            timer: { d:0, h:0, m:0, s:0, wallet:0, totalSaved:0, totalHours:0 },
            regMode: 'normal',
            previewImages: { normal: null, happy: null, sad: null },
            dialogue: "ãŠã‹ãˆã‚Šï¼"
        };

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
        function getEl(id) { return document.getElementById(id); }

        function save() {
            try {
                localStorage.setItem(APP_KEY + '_profile', JSON.stringify(state.profile));
                localStorage.setItem(APP_KEY + '_heroines', JSON.stringify(state.heroines));
            } catch(e) { alert('ä¿å­˜å®¹é‡ä¸è¶³ã§ã™'); }
        }

        function load() {
            try {
                var p = localStorage.getItem(APP_KEY + '_profile');
                var h = localStorage.getItem(APP_KEY + '_heroines');
                if (p && h) {
                    state.profile = JSON.parse(p);
                    state.heroines = JSON.parse(h);
                    return true;
                }
            } catch(e) {}
            return false;
        }

        // --- ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ ---
        function init() {
            try {
                if (load() && state.profile.startQuitDate) {
                    state.view = 'main';
                    checkLoginBonus();
                } else {
                    state.profile = { dailyTarget: 20, pricePerPack: 600, money: 0, love: 0, goalName: '', goalCost: 0, lastLoginDate: null, giftHistory: {} };
                    state.view = 'setup';
                }
                setInterval(tick, 1000); // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
                render();
                
                // ãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ãŸã‚‰Loadingç”»é¢ã‚’æ¶ˆã™
                var loadingEl = getEl('loading');
                if(loadingEl) loadingEl.style.display = 'none';
            } catch(e) {
                alert("èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        }

        function tick() {
            if (!state.profile || !state.profile.startQuitDate) return;
            var now = new Date();
            var start = new Date(state.profile.startQuitDate);
            var diff = now - start;
            if (diff < 0) return;

            state.timer.d = Math.floor(diff / (1000 * 60 * 60 * 24));
            state.timer.h = Math.floor((diff / (1000 * 60 * 60)) % 24);
            state.timer.m = Math.floor((diff / (1000 * 60)) % 60);
            state.timer.s = Math.floor((diff / 1000) % 60);

            var totalHours = diff / (1000 * 60 * 60);
            state.timer.totalHours = totalHours;

            var totalDays = diff / (1000 * 60 * 60 * 24);
            state.timer.totalSaved = Math.floor(totalDays * state.profile.dailyTarget * (state.profile.pricePerPack / 20));
            // wallet = accumulated(è£œæ­£å€¤) + totalSaved
            state.timer.wallet = (state.profile.accumulatedMoney || 0) + state.timer.totalSaved;

            if (state.view === 'main') {
                updateText('timer-d', state.timer.d);
                updateText('timer-h', state.timer.h);
                updateText('timer-m', state.timer.m);
                updateText('timer-s', state.timer.s);
                updateText('val-total', 'Â¥' + state.timer.totalSaved.toLocaleString());
                updateText('val-wallet', 'Â¥' + state.timer.wallet.toLocaleString());
                
                // ç›®æ¨™ãƒãƒ¼æ›´æ–°
                if (state.profile.goalCost > 0) {
                    var percent = Math.min(100, (state.timer.totalSaved / state.profile.goalCost) * 100);
                    var bar = getEl('goal-bar');
                    if(bar) bar.style.width = percent + '%';
                    updateText('goal-percent', Math.floor(percent) + '%');
                }
            }
        }

        function updateText(id, text) {
            var el = getEl(id);
            if (el) el.textContent = text;
        }

        function checkLoginBonus() {
            var today = new Date().toDateString();
            if (state.profile.lastLoginDate !== today) {
                var item = OMIKUJI[Math.floor(Math.random() * OMIKUJI.length)];
                state.profile.love += item.love;
                state.profile.lastLoginDate = today;
                save();
                showPopup('ğŸ ä»Šæ—¥ã®é‹å‹¢: ' + item.type, item.msg, 'å¥½æ„Ÿåº¦ +' + item.love);
            }
            updateDialogue();
        }

        function updateDialogue() {
            var h = new Date().getHours();
            var key = (h >= 5 && h < 11) ? 'morning' : (h >= 11 && h < 18) ? 'day' : (h >= 23 || h < 4) ? 'lateNight' : 'night';
            var list = SCENARIO[key];
            state.dialogue = list[Math.floor(Math.random() * list.length)];
            var el = getEl('dialogue-text');
            if(el) el.innerText = state.dialogue;
        }

        // --- ç”»åƒå‡¦ç† (å®‰å…¨ç‰ˆ) ---
        function handleFile(input, type) {
            var file = input.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = new Image();
                img.onload = function() {
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');
                    var w = img.width, h = img.height;
                    var max = 500;
                    if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    state.previewImages[type] = canvas.toDataURL('image/jpeg', 0.7);
                    render(); // å†æç”»
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
        function nextSetup() {
            var c = parseInt(getEl('inp-c').value);
            var p = parseInt(getEl('inp-p').value);
            var gn = getEl('inp-gn').value;
            var gc = parseInt(getEl('inp-gc').value) || 0;
            state.profile.dailyTarget = c;
            state.profile.pricePerPack = p;
            state.profile.goalName = gn;
            state.profile.goalCost = gc;
            state.view = 'char_reg';
            render();
        }

        function startApp() {
            if (!state.previewImages.normal) return alert('é€šå¸¸ç”»åƒã¯å¿…é ˆã§ã™');
            var h = {
                id: Date.now().toString(),
                img: state.previewImages.normal,
                imgHappy: state.previewImages.happy || state.previewImages.normal,
                imgSad: state.previewImages.sad || state.previewImages.normal
            };
            state.heroines = [h];
            state.profile.currentHeroineId = h.id;
            state.profile.startQuitDate = new Date().toISOString();
            save();
            state.view = 'main';
            render();
            updateDialogue();
        }

        function buyGift(idx) {
            var g = GIFTS[idx];
            if (state.timer.wallet < g.cost) return alert('æ®‹é«˜ãŒè¶³ã‚Šã¾ã›ã‚“');
            
            state.profile.love += g.love;
            state.profile.accumulatedMoney = (state.profile.accumulatedMoney || 0) - g.cost;
            if (!state.profile.giftHistory) state.profile.giftHistory = {};
            state.profile.giftHistory[g.id] = (state.profile.giftHistory[g.id] || 0) + 1;
            save();
            
            // ç”»é¢æ›´æ–°
            render(); 
            showPopup('ğŸ ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã—ã¾ã—ãŸï¼', g.name + 'ã‚’ã‚ã’ã¾ã—ãŸï¼', 'å¥½æ„Ÿåº¦ +' + g.love);
            
            // ç”»åƒã‚’ç¬‘é¡”ã« (DOMç›´æ¥æ“ä½œ)
            var imgEl = getEl('main-img');
            if(imgEl && state.heroines[0].imgHappy) imgEl.src = state.heroines[0].imgHappy;
            
            setTimeout(function() {
                if(!state.modal && getEl('main-img')) getEl('main-img').src = state.heroines[0].img;
            }, 3000);
        }

        function openSos() { state.modal = 'sos'; render(); }
        function closeSos() { state.modal = null; render(); }
        
        function execReset() {
            state.profile.startQuitDate = new Date().toISOString();
            state.profile.accumulatedMoney = 0;
            state.profile.love = Math.max(0, state.profile.love - 50);
            save();
            state.modal = null;
            render();
            alert('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
        }

        function execPenalty() {
            state.profile.accumulatedMoney = (state.profile.accumulatedMoney || 0) - state.profile.pricePerPack;
            state.profile.love = Math.max(0, state.profile.love - 10);
            save();
            state.modal = null;
            render();
            alert('1æœ¬åˆ†ã‚’æ²¡åã—ã¾ã—ãŸã€‚');
        }

        function showPopup(title, msg, sub) {
            state.popupData = { title: title, msg: msg, sub: sub };
            state.modal = 'popup';
            render();
        }
        function closePopup() {
            state.modal = null;
            render();
        }

        // --- HTMLç”Ÿæˆ (Render) ---
        function render() {
            var app = getEl('app');
            var html = '';

            // 1. Setup
            if (state.view === 'setup') {
                html = `
                <div class="container" style="justify-content:center;">
                    <div class="card" style="max-width:320px;">
                        <h2 class="text-center text-rose mb-2">ç¦ç…™ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«</h2>
                        <div class="input-group">
                            <label class="label">1æ—¥ã®æœ¬æ•°</label>
                            <input id="inp-c" type="number" value="20" class="input">
                        </div>
                        <div class="input-group">
                            <label class="label">1ç®±ã®å€¤æ®µ</label>
                            <input id="inp-p" type="number" value="600" class="input">
                        </div>
                        <hr style="border:none; border-top:1px solid #eee; margin:15px 0;">
                        <div class="input-group">
                            <label class="label">ç›®æ¨™ï¼ˆæ¬²ã—ã„ã‚‚ã®ï¼‰</label>
                            <input id="inp-gn" type="text" placeholder="ä¾‹: ç„¼è‚‰" class="input" style="margin-bottom:5px;">
                            <input id="inp-gc" type="number" placeholder="é‡‘é¡ (å††)" class="input">
                        </div>
                        <button onclick="nextSetup()" class="btn btn-primary mt-4">æ¬¡ã¸</button>
                    </div>
                </div>`;
            }
            // 2. Char Reg
            else if (state.view === 'char_reg') {
                var img = state.previewImages[state.regMode];
                html = `
                <div class="container" style="justify-content:center;">
                    <div class="card" style="max-width:320px;">
                        <h2 class="text-center text-rose mb-2">ç”»åƒè¨­å®š</h2>
                        <div style="display:flex; gap:5px; margin-bottom:15px;">
                            <button onclick="state.regMode='normal';render()" class="btn btn-small" style="background:${state.regMode=='normal'?'#f43f5e':'#eee'}; color:${state.regMode=='normal'?'white':'#666'}">é€šå¸¸</button>
                            <button onclick="state.regMode='happy';render()" class="btn btn-small" style="background:${state.regMode=='happy'?'#facc15':'#eee'}; color:${state.regMode=='happy'?'#713f12':'#666'}">ç¬‘é¡”</button>
                            <button onclick="state.regMode='sad';render()" class="btn btn-small" style="background:${state.regMode=='sad'?'#3b82f6':'#eee'}; color:${state.regMode=='sad'?'white':'#666'}">æ‚²ã—ã¿</button>
                        </div>
                        <div style="width:200px; height:200px; background:#f1f5f9; border-radius:20px; overflow:hidden; margin:0 auto; position:relative; border:2px dashed #cbd5e1;">
                            ${img ? `<img src="${img}" style="width:100%; height:100%; object-fit:cover;">` : '<div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#94a3b8;">ç”»åƒã‚’é¸æŠ</div>'}
                            <input type="file" accept="image/*" onchange="handleFile(this, '${state.regMode}')" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0;">
                        </div>
                        <button onclick="startApp()" class="btn btn-primary mt-4">ã“ã‚Œã§é–‹å§‹</button>
                    </div>
                </div>`;
            }
            // 3. Main
            else if (state.view === 'main') {
                var h = state.heroines[0];
                var displayImg = h.img;
                if (state.modal === 'sos') displayImg = h.imgSad;
                else if (state.modal === 'popup') displayImg = h.imgHappy;

                var goalPercent = (state.profile.goalCost > 0) ? Math.min(100, (state.timer.totalSaved / state.profile.goalCost) * 100) : 0;
               
