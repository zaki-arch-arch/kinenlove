<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>ãƒˆã‚­ãƒ¡ã‚­ç¦ç…™ãƒ¡ãƒ¢ãƒªã‚¢ãƒ« v11.0</title>
<!-- Tailwind CSS (ãƒ‡ã‚¶ã‚¤ãƒ³ç”¨) -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* åŸºæœ¬è¨­å®š */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: #fff1f2; /* rose-50 */
        color: #334155; /* slate-700 */
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior-y: none;
        user-select: none;
        padding-bottom: 120px;
        margin: 0;
        min-height: 100vh;
    }
    
    /* è¡¨ç¤ºåˆ¶å¾¡ */
    .hidden { display: none !important; }
    
    /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
    .animate-breathe { animation: breathe 6s ease-in-out infinite; }
    
    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-5px); } }
    .animate-float { animation: float 4s ease-in-out infinite; }

    @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-pulse-slow { animation: pulse-slow 2s infinite; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
</style>
</head>
<body class="bg-rose-50 text-slate-700">

    <!-- 1. ãƒ­ãƒ¼ãƒ‰ç”»é¢ -->
    <div id="view-loading" class="fixed inset-0 bg-rose-50 flex flex-col items-center justify-center z-[9999]">
        <div class="text-6xl mb-4 animate-bounce">ğŸ’—</div>
        <div class="font-bold text-rose-400 mb-8">Loading...</div>
        <!-- æ•‘æ¸ˆãƒœã‚¿ãƒ³: JSãŒä¸€éƒ¨å£Šã‚Œã¦ã„ã¦ã‚‚å‹•ãã‚ˆã†ã«onclickã«ç›´æ›¸ã -->
        <button onclick="if(confirm('ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')){localStorage.clear();location.reload();}" class="px-6 py-3 bg-white border border-slate-300 rounded-full text-xs text-slate-500 shadow-sm active:bg-slate-100">
            å‹•ã‹ãªã„å ´åˆã¯ã“ã“ã‚’ã‚¿ãƒƒãƒ—<br>(å¼·åˆ¶åˆæœŸåŒ–)
        </button>
    </div>

    <!-- 2. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ -->
    <div id="view-setup" class="hidden min-h-screen flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-[2rem] shadow-xl w-full max-w-sm space-y-5 animate-float border-b-4 border-rose-100">
            <h1 class="text-xl font-black text-rose-500 text-center flex items-center justify-center gap-2">
                <span>ğŸ’–</span> ç¦ç…™ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«
            </h1>
            <div>
                <label class="text-xs font-bold text-slate-400 ml-1">1æ—¥ã®æœ¬æ•°</label>
                <input id="inp-c" type="number" value="20" class="w-full p-3 bg-rose-50 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-rose-200 border border-slate-100">
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400 ml-1">1ç®±ã®å€¤æ®µ</label>
                <input id="inp-p" type="number" value="600" class="w-full p-3 bg-rose-50 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-rose-200 border border-slate-100">
            </div>
            <div class="pt-2 border-t border-rose-100">
                <p class="text-xs font-bold text-rose-400 mb-2">âœ¨ ç›®æ¨™ï¼ˆæ¬²ã—ã„ã‚‚ã®ï¼‰</p>
                <input id="inp-gn" type="text" placeholder="ä¾‹: ç„¼è‚‰" class="w-full p-3 bg-rose-50 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-rose-200 mb-2 border border-slate-100">
                <input id="inp-gc" type="number" placeholder="é‡‘é¡ (å††)" class="w-full p-3 bg-rose-50 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-rose-200 border border-slate-100">
            </div>
            <button onclick="app.nextSetup()" class="w-full bg-rose-500 text-white py-4 rounded-full font-bold shadow-lg shadow-rose-200 active:scale-95 transition mt-2">
                æ¬¡ã¸
            </button>
        </div>
    </div>

    <!-- 3. ã‚­ãƒ£ãƒ©ç™»éŒ²ç”»é¢ -->
    <div id="view-char" class="hidden min-h-screen flex flex-col items-center justify-center p-6 text-center">
        <h2 class="text-xl font-bold text-slate-700 mb-6">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚’é¸ã‚“ã§ã­</h2>
        
        <div class="flex bg-white rounded-full p-1.5 shadow-sm mb-6 w-full max-w-xs border border-rose-100">
            <button onclick="app.setRegMode('normal')" id="btn-mode-normal" class="flex-1 py-2 text-xs font-bold rounded-full transition bg-rose-500 text-white">é€šå¸¸</button>
            <button onclick="app.setRegMode('happy')" id="btn-mode-happy" class="flex-1 py-2 text-xs font-bold rounded-full transition text-slate-400">ç¬‘é¡”</button>
            <button onclick="app.setRegMode('sad')" id="btn-mode-sad" class="flex-1 py-2 text-xs font-bold rounded-full transition text-slate-400">æ‚²ã—ã¿</button>
        </div>

        <div id="preview-area" class="relative w-64 h-64 bg-white border-4 border-dashed border-rose-200 rounded-[2.5rem] flex items-center justify-center overflow-hidden shadow-sm mb-8 transition-colors">
            <!-- ç”»åƒãŒãªã„æ™‚ã®è¡¨ç¤º -->
            <div id="preview-placeholder" class="text-center p-4 text-rose-300">
                <div class="text-4xl mb-2">ğŸ“·</div>
                <span class="text-xs font-bold">ç”»åƒã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</span>
            </div>
            <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <img id="preview-img" class="absolute inset-0 w-full h-full object-cover hidden">
            <!-- ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
            <input type="file" accept="image/*" onchange="app.handleFile(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
        </div>

        <p class="text-xs text-slate-400 mb-4">â€»ç¬‘é¡”ãƒ»æ‚²ã—ã¿ã¯æœªè¨­å®šã§ã‚‚OKã§ã™</p>

        <button onclick="app.startMain()" class="w-full max-w-xs bg-rose-500 text-white py-4 rounded-full font-bold shadow-lg shadow-rose-200 active:scale-95 transition">
            ç¦ç…™ç”Ÿæ´»ã‚’å§‹ã‚ã‚‹
        </button>
    </div>

    <!-- 4. ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="view-main" class="hidden w-full min-h-screen">
        <!-- èƒŒæ™¯è£…é£¾ -->
        <div class="fixed top-0 left-0 w-full h-80 bg-rose-100 rounded-b-[60px] -z-10 shadow-inner"></div>

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="flex justify-between items-center p-6 pt-10 sticky top-0 z-40 bg-rose-100/80 backdrop-blur-sm rounded-b-2xl">
            <div class="flex items-center gap-2 text-rose-500 font-bold bg-white/90 px-4 py-1.5 rounded-full shadow-sm border border-white">
                <span>â¤ï¸</span> <span id="disp-lv">Lv.1</span>
            </div>
            <button onclick="app.openResetModal()" class="bg-white/90 text-slate-400 text-xs font-bold px-3 py-2 rounded-full shadow-sm border border-white active:scale-95 transition flex items-center gap-1">
                ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
            </button>
        </div>

        <!-- ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚¨ãƒªã‚¢ -->
        <div class="flex flex-col items-center mt-4 z-10">
            <div onclick="app.tapHeroine()" class="w-72 h-72 rounded-full border-[8px] border-white shadow-xl overflow-hidden bg-slate-100 animate-breathe relative cursor-pointer active:scale-95 transition-transform">
                <img id="main-heroine-img" class="w-full h-full object-cover">
            </div>
            
            <div class="relative mt-[-25px] z-20 w-[85%] max-w-sm">
                <div class="bg-white/95 backdrop-blur-sm p-5 rounded-2xl shadow-lg border border-rose-100 text-center animate-float">
                    <p id="main-dialogue" class="text-sm font-bold text-slate-700 leading-relaxed">ä»Šæ—¥ã‚‚æˆ‘æ…¢ã§ãã¦å‰ã„ï¼</p>
                    <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-white rotate-45 border-t border-l border-rose-100"></div>
                </div>
            </div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¨ãƒªã‚¢ -->
        <div class="mt-8 px-6 grid grid-cols-2 gap-4">
            <!-- ç¦ç…™æ™‚é–“ -->
            <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-50 flex flex-col items-center justify-center h-36 text-center">
                <div class="text-slate-300 mb-1 text-xl">â°</div>
                <div class="text-[10px] text-slate-400 font-bold mb-1">ç¦ç…™æ™‚é–“</div>
                <div class="font-black text-slate-700 leading-tight">
                    <div><span id="timer-d" class="text-xl">0</span><span class="text-xs">æ—¥</span> <span id="timer-h" class="text-xl">0</span><span class="text-xs">æ™‚é–“</span></div>
                    <div class="mt-1"><span id="timer-m" class="text-lg">0</span><span class="text-xs">åˆ†</span> <span id="timer-s" class="text-lg text-rose-500 font-mono">00</span><span class="text-xs">ç§’</span></div>
                </div>
            </div>
            <!-- ç´¯è¨ˆç¯€ç´„ -->
            <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-50 flex flex-col items-center justify-between h-36 text-center">
                <div class="flex flex-col items-center w-full">
                    <div class="text-rose-300 mb-1 text-xl">ğŸ–</div>
                    <div class="text-[10px] text-slate-400 font-bold mb-1">ç´¯è¨ˆç¯€ç´„</div>
                    <div id="val-total" class="text-2xl font-black text-rose-500">Â¥0</div>
                </div>
                
                <!-- ç›®æ¨™ãƒãƒ¼ -->
                <div id="goal-area" class="w-full hidden">
                    <div class="flex justify-between text-[10px] text-slate-500 mb-1 font-bold">
                        <span id="goal-name" class="truncate max-w-[60px]">ç›®æ¨™</span>
                        <span id="goal-percent">0%</span>
                    </div>
                    <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
                        <div id="goal-bar" class="h-full bg-rose-400 transition-all duration-1000" style="width:0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SOSãƒœã‚¿ãƒ³ -->
        <div class="mt-6 px-6">
            <button onclick="app.openSos()" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold shadow-xl shadow-slate-300 flex items-center justify-center gap-2 active:scale-95 transition overflow-hidden relative">
                <div class="absolute inset-0 bg-white/10 animate-pulse-slow"></div>
                <span>âš ï¸</span> <span class="text-lg">å¸ã„ãŸããªã£ãŸã‚‰æŠ¼ã—ã¦</span>
            </button>
        </div>

        <!-- æ¨ã—æ´»ã‚·ãƒ§ãƒƒãƒ— -->
        <div class="mt-10 px-6">
            <div class="flex justify-between items-end mb-4">
                <h3 class="font-bold text-slate-700 flex items-center gap-2 text-sm">
                    <span>ğŸ</span> æ¨ã—æ´»ã‚·ãƒ§ãƒƒãƒ—
                </h3>
                <div class="text-[10px] font-bold text-slate-400 bg-white px-3 py-1.5 rounded-full border border-slate-100 shadow-sm">
                    æ®‹é«˜: <span id="val-wallet" class="text-rose-500 text-base ml-1">Â¥0</span>
                </div>
            </div>
            
            <div id="gift-list" class="flex gap-3 overflow-x-auto no-scrollbar pb-4 -mx-6 px-6">
                <!-- ã‚®ãƒ•ãƒˆã¯JSã§ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ (å¥½æ„Ÿåº¦) -->
        <div class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-md border-t border-slate-100 p-4 pb-8 safe-area-pb z-30 shadow-[0_-5px_20px_rgba(0,0,0,0.02)]">
            <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-2">
                <span>LOVE POINT</span>
                <span id="love-text">0 / 100</span>
            </div>
            <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden">
                <div id="love-bar" class="h-full bg-gradient-to-r from-rose-300 to-rose-500 transition-all duration-1000" style="width:0%"></div>
            </div>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: SOS -->
        <div id="modal-sos" class="hidden fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center text-white p-6 animate-fade-in">
            <button onclick="app.closeSos()" class="absolute top-6 right-6 p-2 bg-white/10 rounded-full z-50">âœ•</button>
            <h2 class="text-3xl font-black text-rose-400 mb-8 animate-pulse tracking-widest mt-10">EMERGENCY</h2>
            <div class="relative w-64 h-64 mb-8">
                <div class="w-full h-full rounded-full border-4 border-rose-500/50 shadow-[0_0_50px_rgba(244,63,94,0.3)] overflow-hidden bg-slate-800 relative z-10 animate-breathe">
                    <img id="sos-img" class="w-full h-full object-cover filter grayscale-[30%] brightness-75">
                </div>
            </div>
            <div class="w-full max-w-sm text-center space-y-6 relative z-10">
                <div class="bg-white/10 backdrop-blur-md p-6 rounded-2xl border border-white/10">
                    <p id="sos-msg" class="text-lg font-bold leading-relaxed">ã€Œãƒ€ãƒ¡ï¼å¸ã£ãŸã‚‰æ‚²ã—ã„ã‚ˆï¼Ÿã€</p>
                </div>
                <div class="flex gap-4 justify-center mt-4">
                    <button onclick="app.closeSos()" class="bg-rose-500 hover:bg-rose-600 text-white px-8 py-3 rounded-full font-bold shadow-lg active:scale-95 transition">æˆ‘æ…¢ã™ã‚‹</button>
                    <button onclick="app.execPenalty()" class="bg-transparent border border-white/20 text-white/40 px-4 py-3 rounded-full text-xs active:bg-white/10">å¸ã†(ãƒšãƒŠãƒ«ãƒ†ã‚£)</button>
                </div>
            </div>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ãƒªã‚»ãƒƒãƒˆ -->
        <div id="modal-reset" class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
            <div class="bg-white rounded-3xl p-6 w-full max-w-sm text-center shadow-2xl">
                <div class="text-4xl mb-4">ğŸ—‘ï¸</div>
                <h3 class="text-xl font-black text-slate-800 mb-2">ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h3>
                <p class="text-sm text-slate-500 mb-6 leading-relaxed">ã“ã‚Œã¾ã§ã®è¨˜éŒ²ã€ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã®æ€ã„å‡ºãŒ<br/>ã™ã¹ã¦æ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ã€‚</p>
                <div class="flex gap-3">
                    <button onclick="app.closeResetModal()" class="flex-1 py-3 rounded-xl font-bold bg-slate-100 text-slate-600">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="app.hardReset()" class="flex-1 py-3 rounded-xl font-bold bg-rose-500 text-white shadow-lg">å‰Šé™¤ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript ãƒ­ã‚¸ãƒƒã‚¯ (å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸ä½¿ç”¨ã®å®‰å…¨è¨­è¨ˆ) -->
    <script>
    (function() {
        // åå‰ç©ºé–“
        var APP_KEY = 'tokikin_v11_0';
        var DATA = {
            profile: null,
            heroines: [],
            regMode: 'normal',
            previewImages: { normal: null, happy: null, sad: null }
        };

        // ã‚®ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿
        var GIFTS = [
            { id: 1, name: 'ã‚¹ã‚¤ãƒ¼ãƒ„', cost: 500, icon: 'ğŸ°', love: 15 },
            { id: 2, name: 'ã‚³ã‚¹ãƒ¡', cost: 3000, icon: 'ğŸ’„', love: 80 },
            { id: 3, name: 'æ¸©æ³‰æ—…è¡Œ', cost: 15000, icon: 'â™¨ï¸', love: 450 },
            { id: 4, name: 'æŒ‡è¼ª', cost: 100000, icon: 'ğŸ’', love: 2500 }
        ];

        // ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿
        var SCENARIOS = {
            stage1: {
                morning: ["ãŠã¯ã‚ˆã†ï¼ä»Šæ—¥ã‚‚è‚ºã‚’ã‚­ãƒ¬ã‚¤ã«ã—ã‚ˆã†ï¼", "æœã®æ·±å‘¼å¸ã€æ°—æŒã¡ã„ã„ï¼Ÿ", "ä»Šæ—¥ã‚‚è¨˜éŒ²æ›´æ–°é ‘å¼µã‚ã†ï¼"],
                day: ["ãŠç–²ã‚Œæ§˜ï¼æ°´é£²ã‚“ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã‚ˆï¼Ÿ", "åˆå¾Œã®çœ æ°—ã¯ã‚¹ãƒˆãƒ¬ãƒƒãƒã§é£›ã°ãã†ï¼", "é ‘å¼µã£ã¦ã‚‹ã­ï¼ã™ã”ã„ã‚ˆã€‚"],
                night: ["ä»Šæ—¥ã‚‚ãŠç–²ã‚Œæ§˜ã€‚å¸ã‚ãšã«å‰ã„ï¼", "æ˜æ—¥ã®ç›®è¦šã‚ãŒæ¥½ã—ã¿ã ã­ã€‚", "ã‚†ã£ãã‚ŠãŠé¢¨å‘‚ã«å…¥ã£ã¦ä¼‘ã‚“ã§ã­ã€‚"],
                lateNight: ["ã¾ã èµ·ãã¦ã‚‹ã®ï¼Ÿæ—©ãå¯ãªã„ã¨è‚Œã«æ‚ªã„ã‚ˆã€‚", "ã“ã‚“ãªæ™‚é–“ã¾ã§èµ·ãã¦ã¦å¤§ä¸ˆå¤«ï¼Ÿ"]
            },
            stage2: {
                morning: ["ãŠã¯ã‚ˆï¼â€¦ã­ãˆã€ç§ã¨ã®ç”˜ã„ç©ºæ°—å¸ã£ã¦ï¼Ÿ", "ä»Šæ—¥ã‚‚ä¼šãˆã¦å¬‰ã—ã„ãªã€‚", "ä¸€æ—¥ä¸­ä¸€ç·’ã ã‚ˆã€‚ç§ã ã‘è¦‹ã¦ã¦ã­ï¼Ÿ"],
                day: ["ã­ãˆã­ãˆã€æµ®ã„ãŸãŠé‡‘ã§ãƒ‡ãƒ¼ãƒˆè¡ŒããŸã„ãªã€‚", "ä»•äº‹é ‘å¼µã£ã¦ã‚‹èƒŒä¸­ã€å¥½ãã‹ã‚‚ã€‚", "è‚Œãƒ„ãƒ¤è‰¯ããªã£ãŸï¼Ÿãƒ‰ã‚­ãƒƒã¨ã—ãŸã€‚"],
                night: ["ãŠã‹ãˆã‚Šã€‚ä»Šæ—¥ã‚‚æˆ‘æ…¢ã§ãã¦å‰ã„ï¼", "ã‚‚ã†ã‚¿ãƒã‚³ãªã‚“ã¦å¿…è¦ãªã„ã­ã€‚", "ç§ãŒã„ã‚Œã°å¹³æ°—ã§ã—ã‚‡ï¼Ÿ"],
                lateNight: ["ãµã‚ãâ€¦çœ ã„â€¦ã€‚ä¸€ç·’ã«å¯ã‚ˆï¼Ÿ", "å¤¢ã®ä¸­ã§ã‚‚å¿œæ´ã—ã¦ã‚‹ã­ã€‚"]
            },
            stage3: {
                morning: ["ã‚“â€¦ãŠã¯ã‚ˆã€‚æœã‹ã‚‰ã‚ãªãŸã‚’è¦‹ã‚Œã¦å¹¸ã›ã€‚", "ä¸€ç”Ÿéš£ã«ã„ã¦ã­ã€‚ç´„æŸã ã‚ˆã€‚", "ç§ã®ã“ã¨ã€ã©ã‚Œãã‚‰ã„å¥½ãï¼Ÿ"],
                day: ["ä»–ã®ã“ã¨è€ƒãˆã¡ã‚ƒãƒ€ãƒ¡ã€‚", "ã‚­ã‚¹ã—ã¦ã‚‚ã„ã„ï¼Ÿ", "ã‚‚ã†é›¢ã•ãªã„ã‹ã‚‰ã­ã€‚"],
                night: ["ãšã£ã¨ä¸€ç·’ã«ã„ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚", "ä¸–ç•Œä¸­ã®èª°ã‚ˆã‚Šã‚‚å¤§åˆ‡ã ã‚ˆã€‚", "ã‚ãªãŸã®å¥åº·ãŒç§ã®å¹¸ã›ã€‚"],
                lateNight: ["ã¾ã å¯ãªã„ã®ï¼Ÿæœã¾ã§ä»˜ãåˆã†ã‚ˆã€‚", "å¯é¡”ã€ãšã£ã¨è¦‹ã¦ã¦ã‚ã’ã‚‹ã€‚"]
            }
        };

        var SOS_MSGS = [
            "ãƒ€ãƒ¡ï¼ã“ã“ã§å¸ã£ãŸã‚‰æ‚²ã—ã„ã‚ˆï¼Ÿ", "ç§ã«ãŠé¡˜ã„ã€‚æˆ‘æ…¢ã—ã¦ï¼Ÿ", "æ·±å‘¼å¸ã—ã¦ã€‚ç§ãŒã¤ã„ã¦ã‚‹ã€‚", "å¥åº·ã‚’å®³ã™ã‚‹ã®ãŒä¸€ç•ªè¾›ã„ã‚ˆã€‚"
        ];

        // --- DOMãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
        function get(id) { return document.getElementById(id); }
        function show(id) { get(id).classList.remove('hidden'); }
        function hide(id) { get(id).classList.add('hidden'); }
        function setText(id, txt) { var el = get(id); if(el) el.innerText = txt; }
        
        // --- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ---
        function save() {
            try {
                localStorage.setItem(APP_KEY + '_profile', JSON.stringify(DATA.profile));
                localStorage.setItem(APP_KEY + '_heroines', JSON.stringify(DATA.heroines));
                return true;
            } catch(e) { alert('ä¿å­˜å®¹é‡ãŒã„ã£ã±ã„ã§ã™ã€‚ç”»åƒã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚'); return false; }
        }

        function load() {
            try {
                var p = localStorage.getItem(APP_KEY + '_profile');
                var h = localStorage.getItem(APP_KEY + '_heroines');
                if (p && h) {
                    DATA.profile = JSON.parse(p);
                    DATA.heroines = JSON.parse(h);
                    return true;
                }
            } catch(e) {}
            return false;
        }

        // --- ç”»åƒå‡¦ç† ---
        function resizeImage(file, callback) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = new Image();
                img.onload = function() {
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');
                    var max = 500;
                    var w = img.width; var h = img.height;
                    if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    callback(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- ã‚¢ãƒ—ãƒªæ©Ÿèƒ½ ---
        window.app = {
            // åˆæœŸåŒ–
            init: function() {
                if (load() && DATA.profile.startQuitDate) {
                    this.switchView('main');
                    this.initMain();
                } else {
                    DATA.profile = { dailyTarget: 20, pricePerPack: 600, money: 0, love: 0, goalName: '', goalCost: 0, giftHistory: {} };
                    this.switchView('setup');
                }
                hide('view-loading');
            },

            switchView: function(viewName) {
                hide('view-setup');
                hide('view-char');
                hide('view-main');
                show('view-' + viewName);
            },

            // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            nextSetup: function() {
                DATA.profile.dailyTarget = parseInt(get('inp-c').value);
                DATA.profile.pricePerPack = parseInt(get('inp-p').value);
                DATA.profile.goalName = get('inp-gn').value;
                DATA.profile.goalCost = parseInt(get('inp-gc').value) || 0;
                this.switchView('char');
            },

            // ã‚­ãƒ£ãƒ©ç™»éŒ²
            setRegMode: function(mode) {
                DATA.regMode = mode;
                ['normal', 'happy', 'sad'].forEach(function(m){
                    var btn = get('btn-mode-'+m);
                    if (mode === m) {
                        btn.className = "flex-1 py-2 text-xs font-bold rounded-full transition bg-rose-500 text-white";
                        get('preview-area').style.borderColor = (m==='normal'?'#fecdd3':(m==='happy'?'#fde047':'#93c5fd'));
                    } else {
                        btn.className = "flex-1 py-2 text-xs font-bold rounded-full transition text-slate-400";
                    }
                });
                
                var img = DATA.previewImages[mode];
     
