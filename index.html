<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ãƒˆã‚­ãƒ¡ã‚­ç¦ç…™ãƒ¡ãƒ¢ãƒªã‚¢ãƒ« Legacy</title>
<style>
    /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« (å¤–éƒ¨CSSä¸è¦) */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; font-family: sans-serif; background-color: #fff1f2; color: #334155; }
    
    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .w-full { width: 100%; }
    .h-screen { height: 100vh; }
    .text-center { text-align: center; }
    .bold { font-weight: bold; }
    .mb-4 { margin-bottom: 1rem; }
    .mt-4 { margin-top: 1rem; }
    .p-4 { padding: 1rem; }
    
    /* ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */
    .btn {
        background-color: #f43f5e; color: white; border: none; padding: 12px 24px;
        border-radius: 99px; font-weight: bold; font-size: 16px; cursor: pointer;
        width: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .btn:active { transform: translateY(2px); }
    .btn-secondary { background-color: #334155; }
    
    .card {
        background: white; border-radius: 20px; padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; width: 90%; max-width: 400px;
    }

    .input-group { margin-bottom: 15px; text-align: left; }
    .input-group label { display: block; font-size: 12px; color: #64748b; margin-bottom: 5px; }
    .input-group input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; }

    /* ãƒ¡ã‚¤ãƒ³ç”»é¢ç”¨ */
    .heroine-img {
        width: 280px; height: 280px; border-radius: 50%; object-fit: cover;
        border: 6px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        background-color: #e2e8f0;
    }
    .balloon {
        background: rgba(255,255,255,0.9); padding: 15px; border-radius: 15px;
        border: 1px solid #ffe4e6; margin-top: -20px; position: relative; z-index: 10;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05); max-width: 90%;
    }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
    .status-row { display: flex; gap: 10px; width: 90%; max-width: 400px; margin-top: 20px; }
    .status-card { flex: 1; background: white; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .status-label { font-size: 10px; color: #64748b; font-weight: bold; }
    .status-val { font-size: 18px; font-weight: 900; color: #334155; margin-top: 5px; }
    .status-sub { font-size: 12px; color: #f43f5e; }

    /* ã‚®ãƒ•ãƒˆ */
    .gift-container { width: 90%; max-width: 400px; overflow-x: auto; white-space: nowrap; padding-bottom: 10px; margin-bottom: 80px; }
    .gift-btn {
        display: inline-block; width: 100px; background: white; border-radius: 15px;
        padding: 10px; margin-right: 10px; text-align: center; border: 1px solid #f1f5f9;
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    #loading-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #fff1f2; z-index: 9999; display: flex;
        flex-direction: column; align-items: center; justify-content: center;
    }
</style>
<script>
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ (ES5)
    window.onerror = function(msg, url, line) {
        var el = document.getElementById('error-msg');
        if(el) {
            el.innerHTML = 'Error: ' + msg + '<br>Line: ' + line;
            el.style.display = 'block';
        }
        return false;
    };
</script>
</head>
<body>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° & ã‚¨ãƒ©ãƒ¼ç”»é¢ -->
    <div id="loading-screen">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ’—</div>
        <div style="font-weight: bold; color: #f43f5e;">Loading...</div>
        
        <div id="error-msg" style="display:none; color:red; margin:20px; font-size:12px; border:1px solid red; padding:10px; background:white;"></div>
        
        <button onclick="fullReset()" style="margin-top: 30px; font-size: 12px; color: #666; background: white; border: 1px solid #ccc; padding: 8px 16px; border-radius: 5px;">
            èµ·å‹•ã—ãªã„å ´åˆã¯ã“ã“ã‚’æŠ¼ã—ã¦ä¿®å¾©
        </button>
    </div>

    <!-- ã‚¢ãƒ—ãƒªç”»é¢ -->
    <div id="app-screen" class="container hidden">
        <!-- Header -->
        <div style="width:100%; padding:20px; display:flex; justify-content:flex-end;">
            <button onclick="fullReset()" style="font-size:10px; background:#fff; border:1px solid #ddd; padding:5px 10px; border-radius:20px;">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        </div>

        <!-- Setup View -->
        <div id="view-setup" class="card hidden">
            <h2 class="text-center" style="color:#f43f5e;">ç¦ç…™ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«</h2>
            <div class="input-group">
                <label>1æ—¥ã®æœ¬æ•°</label>
                <input type="number" id="inp-count" value="20">
            </div>
            <div class="input-group">
                <label>1ç®±ã®å€¤æ®µ</label>
                <input type="number" id="inp-price" value="600">
            </div>
            <div class="input-group">
                <label>ç›®æ¨™ï¼ˆæ¬²ã—ã„ã‚‚ã®ï¼‰</label>
                <input type="text" id="inp-goal-name" placeholder="ä¾‹: ç„¼è‚‰">
            </div>
            <div class="input-group">
                <label>ç›®æ¨™é‡‘é¡ (å††)</label>
                <input type="number" id="inp-goal-cost" placeholder="3000">
            </div>
            <button class="btn" onclick="goCharReg()">æ¬¡ã¸</button>
        </div>

        <!-- Char Reg View -->
        <div id="view-char" class="card hidden">
            <h2 class="text-center" style="color:#334155;">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼è¨­å®š</h2>
            <div class="text-center" style="margin:20px 0;">
                <div style="width:150px; height:150px; background:#f1f5f9; border-radius:50%; margin:0 auto; overflow:hidden; border:2px dashed #cbd5e1; position:relative;">
                    <img id="preview-img" style="width:100%; height:100%; object-fit:cover; display:none;">
                    <div id="preview-text" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#94a3b8; font-size:12px;">ç”»åƒã‚’é¸æŠ</div>
                    <input type="file" onchange="handleFile(this)" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0;">
                </div>
            </div>
            <button class="btn" onclick="startMain()">ã“ã‚Œã§å§‹ã‚ã‚‹</button>
        </div>

        <!-- Main View -->
        <div id="view-main" class="container hidden" style="padding-top:0;">
            <!-- Heroine -->
            <div class="heroine-area">
                <img id="main-heroine-img" class="heroine-img">
            </div>
            <div class="balloon" id="main-dialogue">ãŠã‹ãˆã‚Šï¼</div>

            <!-- Status -->
            <div class="status-row">
                <div class="status-card">
                    <div class="status-label">ç¦ç…™æ™‚é–“</div>
                    <div class="status-val" id="disp-time">0æ—¥ 0h</div>
                </div>
                <div class="status-card">
                    <div class="status-label">ç´¯è¨ˆç¯€ç´„</div>
                    <div class="status-val" id="disp-saved" style="color:#f43f5e;">Â¥0</div>
                    <div class="status-label" id="disp-goal-name" style="margin-top:5px;"></div>
                    <div style="width:100%; height:4px; background:#eee; margin-top:2px; border-radius:2px;"><div id="goal-bar" style="height:100%; width:0%; background:#f43f5e;"></div></div>
                </div>
            </div>

            <!-- SOS -->
            <div style="width:90%; max-width:400px; margin-top:20px;">
                <button class="btn btn-secondary" onclick="alert('æˆ‘æ…¢ã—ã¦ï¼å¿œæ´ã—ã¦ã‚‹ã‚ˆï¼')">âš ï¸ å¸ã„ãŸããªã£ãŸã‚‰æŠ¼ã—ã¦</button>
            </div>

            <!-- Gift -->
            <div style="width:90%; max-width:400px; margin-top:20px;">
                <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:bold; margin-bottom:5px;">
                    <span>æ¨ã—æ´»ã‚·ãƒ§ãƒƒãƒ—</span>
                    <span>æ®‹é«˜: <span id="disp-wallet" style="color:#f43f5e;">Â¥0</span></span>
                </div>
                <div class="gift-container" id="gift-list">
                    <!-- JSã§ç”Ÿæˆ -->
                </div>
            </div>
        </div>

    </div>

<script>
// --- ES5 (å¤ã„JS) ã§è¨˜è¿° ---

var APP_KEY = 'tokikin_legacy_v1';

// ãƒ‡ãƒ¼ã‚¿å®šç¾©
var GIFTS = [
    { name: 'ã‚¹ã‚¤ãƒ¼ãƒ„', cost: 500, icon: 'ğŸ°' },
    { name: 'ã‚³ã‚¹ãƒ¡', cost: 3000, icon: 'ğŸ’„' },
    { name: 'æ¸©æ³‰æ—…è¡Œ', cost: 15000, icon: 'â™¨ï¸' },
    { name: 'æŒ‡è¼ª', cost: 100000, icon: 'ğŸ’' }
];

var SCENARIO = [
    "ãŠã¯ã‚ˆã†ï¼ä»Šæ—¥ã‚‚è‚ºã‚’ã‚­ãƒ¬ã‚¤ã«ä¿ã¨ã†ã­ï¼",
    "ãŠç–²ã‚Œæ§˜ï¼æ°´é£²ã‚“ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã‚ˆï¼Ÿ",
    "é ‘å¼µã£ã¦ã‚‹ã­ï¼ã™ã”ã„ã‚ˆã€‚",
    "ä»Šæ—¥ã‚‚æˆ‘æ…¢ã§ãã¦å‰ã„ï¼",
    "æµ®ã„ãŸãŠé‡‘ã§ãƒ‡ãƒ¼ãƒˆè¡ŒããŸã„ãªã€‚",
    "ã‚‚ã†ã‚¿ãƒã‚³ãªã‚“ã¦å¿…è¦ãªã„ã­ã€‚"
];

// çŠ¶æ…‹
var profile = {
    dailyTarget: 20,
    pricePerPack: 600,
    goalName: '',
    goalCost: 0,
    startQuitDate: null,
    accumulatedMoney: 0, // è£œæ­£å€¤
    heroineImg: null
};

// åˆæœŸåŒ–
window.onload = function() {
    try {
        var saved = localStorage.getItem(APP_KEY);
        if (saved) {
            profile = JSON.parse(saved);
        }
        
        if (profile.startQuitDate) {
            showView('main');
            initMain();
        } else {
            showView('setup');
        }
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¶ˆå»
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('app-screen').classList.remove('hidden');
        
    } catch(e) {
        document.getElementById('error-msg').innerText = e.message;
        document.getElementById('error-msg').style.display = 'block';
    }
};

// ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
function showView(name) {
    document.getElementById('view-setup').classList.add('hidden');
    document.getElementById('view-char').classList.add('hidden');
    document.getElementById('view-main').classList.add('hidden');
    
    document.getElementById('view-' + name).classList.remove('hidden');
}

// ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å‡¦ç†
function goCharReg() {
    profile.dailyTarget = parseInt(document.getElementById('inp-count').value);
    profile.pricePerPack = parseInt(document.getElementById('inp-price').value);
    profile.goalName = document.getElementById('inp-goal-name').value;
    profile.goalCost = parseInt(document.getElementById('inp-goal-cost').value) || 0;
    showView('char');
}

// ç”»åƒå‡¦ç†
function handleFile(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            // ç”»åƒã‚’è¡¨ç¤º
            var imgEl = document.getElementById('preview-img');
            imgEl.src = e.target.result;
            imgEl.style.display = 'block';
            document.getElementById('preview-text').style.display = 'none';
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ (ç°¡æ˜“åŒ–ã®ãŸã‚ãã®ã¾ã¾ä¿å­˜)
            profile.heroineImg = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// é–‹å§‹å‡¦ç†
function startMain() {
    if (!profile.heroineImg) {
        alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    profile.startQuitDate = new Date().toISOString();
    saveData();
    showView('main');
    initMain();
}

// ãƒ‡ãƒ¼ã‚¿ä¿å­˜
function saveData() {
    try {
        localStorage.setItem(APP_KEY, JSON.stringify(profile));
    } catch(e) {
        alert('å®¹é‡ãŒã„ã£ã±ã„ã§ã™');
    }
}

// å…¨å‰Šé™¤
function fullReset() {
    if(confirm('ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.removeItem(APP_KEY);
        location.reload();
    }
}

// --- ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
function initMain() {
    // ç”»åƒã‚»ãƒƒãƒˆ
    document.getElementById('main-heroine-img').src = profile.heroineImg;
    
    // ã‚®ãƒ•ãƒˆãƒªã‚¹ãƒˆç”Ÿæˆ
    var giftContainer = document.getElementById('gift-list');
    giftContainer.innerHTML = '';
    for(var i=0; i<GIFTS.length; i++) {
        (function(g) {
            var btn = document.createElement('div');
            btn.className = 'gift-btn';
            btn.innerHTML = '<div style="font-size:24px;">' + g.icon + '</div><div style="font-size:10px;">' + g.name + '</div><div style="font-size:10px;color:#f43f5e;">Â¥' + g.cost + '</div>';
            btn.onclick = function() { buyGift(g); };
            giftContainer.appendChild(btn);
        })(GIFTS[i]);
    }

    // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
    setInterval(updateTimer, 1000);
    updateTimer();
    
    // ã‚»ãƒªãƒ•æ›´æ–°
    document.getElementById('main-dialogue').innerText = SCENARIO[Math.floor(Math.random() * SCENARIO.length)];
}

function updateTimer() {
    if (!profile.startQuitDate) return;
    
    var now = new Date();
    var start = new Date(profile.startQuitDate);
    var diff = now - start;
    
    // æ™‚é–“è¨ˆç®—
    var days = Math.floor(diff / (1000 * 60 * 60 * 24));
    var hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    var mins = Math.floor((diff / (1000 * 60)) % 60);
    
    document.getElementById('disp-time').innerText = days + 'æ—¥ ' + hours + 'æ™‚é–“ ' + mins + 'åˆ†';

    // é‡‘é¡è¨ˆç®—
    var totalMinutes = diff / (1000 * 60);
    // 1æ—¥20æœ¬600å†† -> 1æœ¬30å†† -> 1æœ¬å¸ã†ã®ã«5åˆ†ã‹ã‹ã‚‹ã¨ã—ã¦è¨ˆç®—ã®ç°¡ç•¥åŒ–
    // 1æ—¥ = 1440åˆ†ã€‚ 1æ—¥ã®æ¶ˆè²»é¡ = (æœ¬æ•° * å˜ä¾¡/20)ã€‚
    // 1åˆ†ã‚ãŸã‚Šã®ç¯€ç´„é¡ = (æœ¬æ•° * å˜ä¾¡/20) / 1440
    var yenPerMin = (profile.dailyTarget * (profile.pricePerPack / 20)) / 1440;
    var totalSaved = Math.floor(totalMinutes * yenPerMin);
    
    var wallet = (profile.accumulatedMoney || 0) + totalSaved;
    
    document.getElementById('disp-saved').innerText = 'Â¥' + totalSaved.toLocaleString();
    document.getElementById('disp-wallet').innerText = 'Â¥' + wallet.toLocaleString();
    
    // ç›®æ¨™ãƒãƒ¼
    if (profile.goalName && profile.goalCost > 0) {
        var percent = Math.min(100, (totalSaved / profile.goalCost) * 100);
        document.getElementById('disp-goal-name').innerText = profile.goalName + ' (' + Math.floor(percent) + '%)';
        document.getElementById('goal-bar').style.width = percent + '%';
    }
}

function buyGift(gift) {
    // ç¾åœ¨ã®è¨ˆç®—ä¸Šã®è²¡å¸ƒæ®‹é«˜ã‚’å–å¾—
    var now = new Date();
    var start = new Date(profile.startQuitDate);
    var diff = now - start;
    var totalMinutes = diff / (1000 * 60);
    var yenPerMin = (profile.dailyTarget * (profile.pricePerPack / 20)) / 1440;
    var totalSaved = Math.floor(totalMinutes * yenPerMin);
    var wallet = (profile.accumulatedMoney || 0) + totalSaved;

    if (wallet < gift.cost) {
        alert('ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ã‚ã¨ Â¥' + (gift.cost - wallet) + ' å¿…è¦ã§ã™ã€‚');
        return;
    }
    
    // è³¼å…¥å‡¦ç†ï¼šaccumulatedMoneyã‚’æ¸›ç®—ã—ã¦è²¡å¸ƒã‚’æ¸›ã‚‰ã™
    profile.accumulatedMoney = (profile.accumulatedMoney || 0) - gift.cost;
    saveData();
    
    alert(gift.name + 'ã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã—ã¾ã—ãŸï¼\næ¨ã—ãŒå–œã‚“ã§ã„ã¾ã™ï¼');
    updateTimer(); // å³æ™‚æ›´æ–°
}

</script>
</body>
</html>

